import streamlit as st
import plotly.graph_objects as go
import sys
import os
import pandas as pd
import numpy as np

# [1] ê²½ë¡œ ì„¤ì •
current_dir = os.path.dirname(os.path.abspath(__file__))
parent_dir = os.path.dirname(current_dir)
if parent_dir not in sys.path:
    sys.path.append(parent_dir)

# [2] ë¶€í’ˆ ë¡œë“œ
try:
    from data_fetcher import get_all_market_data
    from calculations import calculate_sector_scores, calculate_individual_metrics, calculate_core_sector_scores
except ImportError as e:
    st.error(f"ğŸš¨ ë¶€í’ˆ ë¡œë”© ì‹¤íŒ¨! (ì—ëŸ¬: {e})")
    st.stop()

st.set_page_config(page_title="ë§¤í¬ë¡œ ìœ„í—˜ì•Œë¦¬ë¯¸", page_icon="ğŸ“Š", layout="wide")

# ğŸ¨ ì¹´ë“œí˜• ìŠ¤íƒ€ì¼ CSS
st.markdown("""
    <style>
    .metric-card {
        background-color: #ffffff;
        border-radius: 12px;
        padding: 15px;
        border: 1px solid #e1e4e8;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 10px;
    }
    .buy-signal { border-left: 5px solid #28a745; background-color: #f8fff9; }
    .sell-signal { border-left: 5px solid #dc3545; background-color: #fff8f8; }
    .wait-signal { border-left: 5px solid #ffc107; background-color: #fffdf5; }
    .ticker-header { font-size: 1rem; font-weight: bold; margin-bottom: 5px; }
    .score-box { font-size: 0.8rem; color: #444; }
    </style>
    """, unsafe_allow_html=True)

st.title("ğŸ“Š ë§¤í¬ë¡œê²½ì œ ìœ„í—˜ì•Œë¦¬ë¯¸")
st.markdown("---")

# [3] ë°ì´í„° ë¡œë”©
@st.cache_data(ttl=300)
def load_all_data():
    return get_all_market_data()

with st.spinner("â³ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."):
    all_data = load_all_data()
    df_sectors = calculate_sector_scores(all_data['sector_etfs'])
    df_individual = calculate_individual_metrics(all_data['individual_stocks'])
    df_core = calculate_core_sector_scores(all_data['core_sectors'])

# [4] ë©”ì¸ ì‹œì¥ ìƒíƒœ ì§€í‘œ
if not df_sectors.empty and 'L-score' in df_sectors.columns:
    col1, col2, col3 = st.columns(3)
    avg_l = df_sectors['L-score'].mean()
    avg_s = df_sectors['S-score'].mean()
    with col1: st.metric("í‰ê·  L-score", f"{avg_l:.2f}", delta="ì¥ê¸° ì²´ë ¥", delta_color="off")
    with col2: st.metric("í‰ê·  S-score", f"{avg_s:.2f}", delta="ë‹¨ê¸° ê¸°ì„¸", delta_color="off")
    with col3:
        if avg_l > 0 and avg_s > 0: st.success("âœ… ë§¤ìˆ˜ ì‹ í˜¸ (ìƒìŠ¹ì¥)")
        elif avg_l < 0 and avg_s < 0: st.error("ğŸš¨ ë²„ë ¤ ë²„ë ¤! (í•˜ë½ì¥)")
        else: st.warning("âš ï¸ ê´€ë§ (ë°©í–¥ íƒìƒ‰)")
    
    st.caption("ğŸ’¡ ì‹œì¥ ìƒíƒœ íŒë³„ ê¸°ì¤€: ì „ì²´ í‰ê·  ì¥ê¸°/ë‹¨ê¸° ìŠ¤ì½”ì–´ê°€ ëª¨ë‘ 0ë³´ë‹¤ í¬ë©´ 'ë§¤ìˆ˜', ëª¨ë‘ 0ë³´ë‹¤ ì‘ìœ¼ë©´ 'ë²„ë ¤', ê·¸ ì™¸ëŠ” 'ê´€ë§'ì…ë‹ˆë‹¤. ê°ê´€ì ì¸ ìˆ«ìë¥¼ ë¯¿ìœ¼ì‹­ì‹œì˜¤.")
else:
    st.error("ğŸš¨ ë°ì´í„° ê³„ì‚° ì˜¤ë¥˜ ë°œìƒ!")

# [5] ì¡°ê¸°ê²½ë³´ ì‹œìŠ¤í…œ
top_5_sectors = df_sectors.head(5)['ì„¹í„°'].tolist()
safe_assets = ['CASH', 'ì¥ê¸°êµ­ì±„', 'ë¬¼ê°€ì—°ë™ì±„', 'ìœ í‹¸ë¦¬í‹°', 'í•„ìˆ˜ì†Œë¹„ì¬']
safe_count = sum(1 for sector in top_5_sectors if sector in safe_assets)
if safe_count >= 2:
    st.error(f"ğŸš¨ **ì•ˆì „ìì‚°
